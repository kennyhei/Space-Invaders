function Drawable(e,t,n,i,o,r){this.x=e,this.y=t,this.width=n,this.height=i,this.column=o,this.row=r}function intersects(e,t,n,i,o,r,a,l){return a+=o,n+=e,!(o>n||e>a)&&(l+=r,i+=t,!(r>i||t>l))}function Movable(e,t,n,i,o,r){Drawable.call(this,e,t,n,i,o,r)}function Animation(e,t,n,i,o,r){this.image=e,this.frame_width=i,this.frame_height=o,this.current_x=t,this.current_y=n,this.change=!0,this.frameAddition=r}function InvaderManager(){function e(e,t){$.each(l,function(n,i){for(var o=0;o<i.length;++o)i[o].move(e,t)})}function t(e,t){for(var i=0;i<l.length;++i)for(var o=0;o<l[i].length;++o){var r=l[i][o];!r.hasCollided()&&e.doesCollide(r,t)&&(r.explode(),n(i,o))}}function n(e,t){setTimeout(function(){a(),r(e,t),--s},100)}function i(e){return e.length>0&&Math.random()<c&&(u.push(e[e.length-1].shoot()),!0)}function o(){for(var e=0;e<l.length;++e)for(var t=0;t<l[e].length;++t)if(l[e][t].collidesWithEdge())return!0;return!1}function r(e,t){l[e].splice(t,1)}function a(){h+=.06,spritemanager.decreaseFrametime()}var l=[],s=55,u=[],h=3,c=.005,d=!0;return $.each(invaderData,function(e,t){var n=new Invader(t[0],t[1],t[2],t[3]),i=e%11;l[i]||(l[i]=[]);var o=spritemanager.getSprite(t[2]);n.createAnimation(o),l[i].push(n)}),{draw:function(e){for(var t=0;t<l.length;++t)for(var n=0;n<l[t].length;++n)l[t][n].draw(e)},doesCollide:function(e,t){for(var i=0;i<l.length;++i)for(var o=0;o<l[i].length;++o){var r=l[i][o];if(!r.hasCollided()&&r.doesCollide(e))return t.raiseScore(r.getRow()),r.explode(),n(i,o),!0}return!1},getNumOfInvaders:function(){return s},shootLogic:function(){for(var e=0;e<l.length;++e)invaderColumnShot[e]||i(l[e])&&(invaderColumnShot[e]=!0);return u},update:function(n,i){t(n,i),o()&&(d?e(-1-h,25):e(1+h,25),d=!d),spritemanager.changeSprite(l)&&(d?e(h,0):e(-h,0))},getInvaders:function(){return l},setSpeed:function(e){h=e},setChance:function(e){c=e}}}function Invader(e,t,n,i){Drawable.call(this,e,t,25,20,i,n),this.sprite=[],this.collision=!1,this.animation={}}function BonusInvader(){Drawable.call(this,10,80,30,20),this.img=new Image,this.img.src="img/bonus.png",this.directionRight=!0}function WallManager(){for(var e=[],t=0;t<4;++t){var n=new Wall(wallData[t],roundedTilesData[t]);e.push(n)}return{draw:function(t){for(var n=0;n<e.length;++n)e[n].draw(t)},doesCollide:function(t,n){for(var i=0;i<e.length;++i)if(e[i].doesCollide(t,n))return!0;return!1}}}function Wall(e,t){function n(e){r.splice(e,1)}var i=new Array,o=new Array,r=new Array;return $.each(t,function(e,t){var n=new RoundedTile(t[0],t[1],t[2]);o.push(n),r.push(n)}),$.each(e,function(e,t){var n=new Tile(t[0],t[1]);i.push(n),r.push(n)}),{draw:function(e){for(var t=0;t<r.length;++t)r[t].draw(e)},doesCollide:function(e,t){for(var i=0;i<r.length;++i)if(r[i].doesCollide(e))return t.newExplosion(r[i].getX(),r[i].getY()),n(i),!0;return!1}}}function Tile(e,t){Drawable.call(this,e,t,14,20)}function RoundedTile(e,t,n){this.clockwise=n,Drawable.call(this,e,t,14,20)}function Player(){Movable.call(this,260,500,25,25),this.lives=3,this.img=new Image,this.img.src="img/ships2.png"}function Missile(e,t,n){Drawable.call(this,e,t,3,5,n)}function ScoreManager(){var e=[];null!==localStorage.getItem("highscore")&&(e=JSON.parse(localStorage.getItem("highscore")));var t=0,n=0;return e.length>0&&(n=e[0]),{raiseScore:function(e){(t+=e<1?30:e<3?20:5==e?100:10)>n&&(n=t)},getScore:function(){return t},getHighScore:function(){return n},showScores:function(t){var n=JSON.parse(localStorage.getItem("highscore"));if(null===n&&(n=e),t.font="20px Courier New",0!==n.length)for(var i=305,o=0;o<n.length;++o)t.fillText(o+1+": "+n[o],230,i),i+=30;else t.fillText("No scores yet! Go and play!",115,305)},postScore:function(){e.push(t),e.sort(function(e,t){return t-e}),e=e.slice(0,5),localStorage.setItem("highscore",JSON.stringify(e))}}}function ExplosionManager(){function e(e){for(var n=0;n<t.length;++n)t[n].draw(e)}var t=[];return{update:function(n){for(var i=0;i<t.length;++i)t[i].empty()&&(t.splice(i,1),--i);t.length>0&&e(n)},newExplosion:function(e,n){t.push(new Explosion(e,n)),soundManager.explosionSound()}}}function Explosion(e,t){this.particles=[];for(var n=0;n<30;++n)this.particles.push(new Particle(e,t))}function Particle(e,t){this.x=e,this.y=t,this.radius=3+4*Math.random(),this.r=255*Math.round(Math.random()),this.g=255*Math.round(Math.random()),this.b=255*Math.round(Math.random()),this.vx=20*Math.random()-10,this.vy=20*Math.random()-10}var spritemanager={};spritemanager=function(){var e=.5,t=0;return{changeSprite:function(n){var i=(new Date).getTime()/1e3;if(i-t>e){for(var o=0;o<n.length;++o)for(var r=0;r<n[o].length;++r)n[o][r].animate(),t=i;return!0}return!1},getSprite:function(e){return sprite=0==e?[0,4,30,25]:1==e||2==e?[69,4,30,25]:[143,4,30,25]},decreaseFrametime:function(){e-=.009},resetFrametime:function(){e=.5}}}();var configuration=function(){function e(){soundManager.disableSounds()}function t(){$("<div/>").attr("id","left").text("Left").appendTo(".buttons"),$("<div/>").attr("id","shoot").text("Shoot").appendTo(".buttons"),$("<div/>").attr("id","right").text("Right").appendTo(".buttons")}function n(){$("#spaceinvaders").click(function(e){var t=Math.floor(e.pageX-$(this).offset().left),n=Math.floor(e.pageY-$(this).offset().top);t>=502&&t<=535&&n>=545&&n<=580&&(soundManager.areSoundsOn()?soundManager.disableSounds():soundManager.enableSounds())})}function i(){$(document).keydown(function(e){keyhandler.keydown(e.which),keyhandler.isValidKey(e.which)&&e.preventDefault()}),$(document).keyup(function(e){keyhandler.keyup(e.which),keyhandler.isValidKey(e.which)&&e.preventDefault()})}function o(){$("#right").swipe({swipeStatus:function(e,t,n,i,o,r){"start"!=t&&"move"!=t||keyhandler.pressRight(),"end"!=t&&"cancel"!=t||keyhandler.clear()}}),$("#left").swipe({swipeStatus:function(e,t,n,i,o,r){"start"!=t&&"move"!=t||keyhandler.pressLeft(),"end"!=t&&"cancel"!=t||keyhandler.clear()}}),$("#shoot").swipe({swipeStatus:function(e,t,n,i,o,r){"start"!=t&&"move"!=t||keyhandler.pressUp(),"end"!=t&&"cancel"!=t||keyhandler.clear()}})}function r(){a()}function a(){var e=localStorage.getItem("userId");if(null!=e&&$.cookie("userId",e),null==$.cookie("userId")){var t=l();localStorage.setItem("userId",t),$.cookie("userId",t,{expires:30})}}function l(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<5;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}return{init:function(){1==jQuery.browser.mobile?(e(),t(),o()):n(),i(),r()}}}(),soundManager=function(){var e=!0,t=$("#8bit-explosion")[0],n=$("#explosion")[0],i=$("#missile")[0],o=$("#flight")[0];return{areSoundsOn:function(){return e},enableSounds:function(){e=!0},disableSounds:function(){e=!1},explosionSound:function(){if(e){var t=n;t.volume=.6,t.load(),t.play()}},eightBitExplosionSound:function(){if(e){var n=t;n.volume=.4,n.load(),n.play()}},missileSound:function(){if(e){var t=i;t.volume=.3,t.load(),t.play()}},flightSound:function(){if(e){var t=o;t.volume=.1,t.play()}}}}();Drawable.prototype.move=function(e,t){this.x+=e,this.y+=t},Drawable.prototype.getX=function(){return this.x},Drawable.prototype.getY=function(){return this.y},Drawable.prototype.getWidth=function(){return this.width},Drawable.prototype.getHeight=function(){return this.height},Drawable.prototype.getColumn=function(){return this.column},Drawable.prototype.getRow=function(){return this.row},Drawable.prototype.doesCollide=function(e){return!!intersects(this.x,this.y,this.width,this.height,e.getX(),e.getY(),e.getWidth(),e.getHeight())},Movable.prototype=new Drawable,Movable.prototype.constructor=Movable,Movable.prototype.shoot=function(){return soundManager.missileSound(),null!=this.column?new Missile(this.x+10,this.y+15,this.column):new Missile(this.x+10,this.y+5,this.column)},Movable.prototype.collidesWithEdge=function(){return this.x>514||this.x<0},Animation.prototype.next=function(){this.change?this.current_x+=this.frameAddition:this.current_x-=this.frameAddition,this.change=!this.change},Animation.prototype.draw=function(e,t,n,i,o){e.drawImage(this.image,this.current_x,this.current_y,this.frame_width,this.frame_height,t,n,i,o)};var invaderData=[[60,135,0,0],[100,135,0,1],[140,135,0,2],[180,135,0,3],[220,135,0,4],[260,135,0,5],[300,135,0,6],[340,135,0,7],[380,135,0,8],[420,135,0,9],[460,135,0,10],[60,160,1,0],[100,160,1,1],[140,160,1,2],[180,160,1,3],[220,160,1,4],[260,160,1,5],[300,160,1,6],[340,160,1,7],[380,160,1,8],[420,160,1,9],[460,160,1,10],[60,185,2,0],[100,185,2,1],[140,185,2,2],[180,185,2,3],[220,185,2,4],[260,185,2,5],[300,185,2,6],[340,185,2,7],[380,185,2,8],[420,185,2,9],[460,185,2,10],[60,210,3,0],[100,210,3,1],[140,210,3,2],[180,210,3,3],[220,210,3,4],[260,210,3,5],[300,210,3,6],[340,210,3,7],[380,210,3,8],[420,210,3,9],[460,210,3,10],[60,235,4,0],[100,235,4,1],[140,235,4,2],[180,235,4,3],[220,235,4,4],[260,235,4,5],[300,235,4,6],[340,235,4,7],[380,235,4,8],[420,235,4,9],[460,235,4,10]],invaderColumnShot=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];Invader.prototype=new Movable,Invader.prototype.constructor=Invader,Invader.prototype.draw=function(e){this.animation.draw(e,this.x,this.y,this.width,this.height)},Invader.prototype.createAnimation=function(e){this.sprite=e,this.animation=new Animation($("#invaders")[0],this.sprite[0],this.sprite[1],this.sprite[2],this.sprite[3],32)},Invader.prototype.animate=function(){this.animation.next()},Invader.prototype.hasCollided=function(){return this.collision},Invader.prototype.explode=function(){soundManager.eightBitExplosionSound(),this.animation=new Animation($("#kaboom")[0],0,0,34,23,0),this.collision=!0},BonusInvader.prototype=new Movable,BonusInvader.prototype.constructor=BonusInvader,BonusInvader.prototype.draw=function(e){soundManager.flightSound(),e.drawImage(this.img,0,0,52,27,this.x,this.y,this.width,this.height)};var keyhandler=function(){function e(){return i[38]||i[175]||i[87]}function t(){return i[37]||i[178]||i[65]}function n(){return i[39]||i[177]||i[68]}for(var i=new Array,o=0;o<256;)i[o]=!1,o+=1;return{isValidKey:function(e){return 38==e||175==e||87==e||32==e||37==e||178==e||65==e||39==e||177==e||68==e||40==e},keydown:function(e){i[e]=!0},keyup:function(e){i[e]=!1},getMovement:function(){var e=0;return t()&&(e=-2),n()&&(e=2),e},getAction:function(){return!(!e()&&!i[32])},clear:function(){for(var e=0;e<256;)i[e]=!1,e+=1},pressLeft:function(){i[37]=!0,i[178]=!0,i[65]=!0},pressRight:function(){i[39]=!0,i[177]=!0,i[68]=!0},pressUp:function(){i[38]=!0,i[175]=!0,i[87]=!0,i[32]=!0}}}(),wallData=[[[77,455],[119,455],[91,435],[105,435]],[[187,455],[229,455],[201,435],[215,435]],[[297,455],[339,455],[311,435],[325,435]],[[407,455],[449,455],[421,435],[435,435]]],roundedTilesData=[[[77,435,!1],[119,435,!0]],[[187,435,!1],[229,435,!0]],[[297,435,!1],[339,435,!0]],[[407,435,!1],[449,435,!0]]];Tile.prototype=new Drawable,Tile.prototype.constructor=Tile,Tile.prototype.draw=function(e){e.fillStyle="rgb(0,255,0)",e.fillRect(this.x,this.y,this.width,this.height)},RoundedTile.prototype=new Drawable,RoundedTile.prototype.constructor=RoundedTile,RoundedTile.prototype.draw=function(e){e.fillStyle="rgb(0,255,0)",e.strokeStyle="rgb(0,255,0)",e.lineWidth=1,e.beginPath(),this.clockwise?this.drawClockWise(e):this.drawCounterClockWise(e),e.stroke(),e.fill()},RoundedTile.prototype.drawClockWise=function(e){e.moveTo(this.x+.5,this.y),e.lineTo(this.x+.5,this.y+this.height-.5),e.lineTo(this.x+this.width-.5,this.y+this.height-.5),e.quadraticCurveTo(this.x+this.width,this.y+.5,this.x,this.y+.5)},RoundedTile.prototype.drawCounterClockWise=function(e){var t=this.x+this.width;e.moveTo(t-.5,this.y),e.lineTo(t-.5,this.y+this.height-.5),e.lineTo(t-this.width+.5,this.y+this.height-.5),e.quadraticCurveTo(t-this.width,this.y+.5,t,this.y+.5)},Player.prototype=new Movable,Player.prototype.constructor=Player,Player.prototype.draw=function(e,t){e.drawImage(this.img,t,12,80,72,this.x,this.y,this.width,this.height)},Missile.prototype=new Drawable,Missile.prototype.constructor=Missile,Missile.prototype.draw=function(e){e.fillStyle="rgb(255,255,255)",e.fillRect(this.x,this.y,this.width,this.height)},Explosion.prototype.empty=function(){for(var e=0;e<this.particles.length;++e)this.particles[e].radius<=0&&(this.particles.splice(e,1),--e);return 0==this.particles.length},Explosion.prototype.draw=function(e){for(var t=0;t<this.particles.length;t++){var n=this.particles[t];e.beginPath(),e.globalCompositeOperation="lighter",e.arc(n.x,n.y,n.radius,0,2*Math.PI,!1),e.fillStyle="rgba("+n.r+", "+n.g+", "+n.b+", 0.5)",e.fill(),n.x+=n.vx,n.y+=n.vy,n.radius-=.2}},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};var engine=function(){function e(e){e.fillStyle="rgb(0,0,0)",e.fillRect(180,265,180,33),e.font="bold 30px Courier New",e.fillStyle="rgb(255,255,255)",e.fillText("GAME OVER",190,280),t(e),$("#spaceinvaders").on("click.endGame",function(e){$("#spaceinvaders").off("click.endGame"),u(),w()})}function t(e){E&&M.postScore(),M.showScores(e)}function n(){b.collidesWithEdge()?b.getX()>514&&x<0?b.move(x,0):b.getX()<0&&x>0&&b.move(x,0):b.collidesWithEdge()||b.move(x,0)}function i(){D&&null==y&&(y=b.shoot()),null!=y&&(T.doesCollide(y,I)||C.doesCollide(y,M)?y=null:null!=m&&m.doesCollide(y)?(y=null,I.newExplosion(m.getX(),m.getY()),m=null,M.raiseScore(5)):y.getY()<70?y=null:y.move(0,-10))}function o(){null==m&&R>0&&C.getNumOfInvaders()<35&&Math.floor(1e3*Math.random()+1)<3&&(m=new BonusInvader,R=0),null!=m&&(m.collidesWithEdge()&&(m.directionRight=!m.directionRight),m.directionRight?m.move(3,0):m.move(-3,0),null==S&&Math.random()<.015&&(S=m.shoot()))}function r(){null!=S&&(b.doesCollide(S)?(b.lives-=1,I.newExplosion(b.getX(),b.getY()),S=null):T.doesCollide(S,I)||S.getY()>533?S=null:S.move(0,3))}function a(){C.update(T,I)}function l(){if((A=C.shootLogic()).length>0)for(var e=0;e<A.length;++e){var t=A[e];b.doesCollide(t)?(b.lives-=1,I.newExplosion(b.getX(),b.getY()),invaderColumnShot[t.getColumn()]=!1,A.splice(e,1),--e):T.doesCollide(t,I)||t.getY()>533?(invaderColumnShot[t.getColumn()]=!1,A.splice(e,1),--e):t.move(0,1)}}function s(e){e.fillStyle="rgb(0,0,0)",e.fillRect(180,265,180,33),e.font="20px Courier New",e.fillStyle="rgb(255,255,255)",e.fillText("CONGRATULATIONS!",178,250),e.fillText("Next level is about to start...",85,280),setTimeout(function(){u(),++k,C.setSpeed(3+k/10),C.setChance(.005+k/250),v()},3e3)}function u(){b.lives<1&&(b=new Player),C=new InvaderManager,T=new WallManager,I=new ExplosionManager,y=null,S=null,m=null,R=1,A=null,spritemanager.resetFrametime(),D=!1,E=!1;for(var e=0;e<invaderColumnShot.length;++e)invaderColumnShot[e]=!1}function h(e){e.lineWidth=2,e.strokeStyle="rgb(0,255,0)",e.beginPath(),e.moveTo(0,540),e.lineTo(540,540),e.stroke();for(var t=b.img,n=50,i=0;i<b.lives;++i)e.drawImage(t,0,12,80,72,n,550,25,25),n+=30;e.font="20px Courier New",e.fillStyle="rgb(255, 255, 255)",e.fillText(b.lives+"x",20,570),e.fillText("LEVEL",340,30),e.fillText(k,340,50)}function c(e){var t=$("#sound-icon")[0];e.drawImage(t,500,543,35,35),soundManager.areSoundsOn()||(e.strokeStyle="rgb(255,255,255)",e.lineWidth=2,e.beginPath(),e.moveTo(507,571),e.lineTo(529,550),e.stroke())}function d(e){e.fillText("SCORE",20,30),e.fillText(M.getScore(),20,50),e.fillText("HIGH SCORE",140,30),e.fillText(M.getHighScore(),140,50)}function f(e){null!=m&&m.draw(e),C.draw(e)}function g(e){var t;t=-2==x?147:2==x?78:0,b.draw(e,t)}function p(e){null!=y&&y.draw(e),null!=S&&S.draw(e),A.length>0&&$.each(A,function(t,n){n.draw(e)})}function v(){engine.input(),engine.logic(),engine.render(),E||requestAnimFrame(engine.tick)}function w(){var e=$("#spaceinvaders")[0].getContext("2d");e.clearRect(0,0,540,580),e.fillStyle="rgb(0,0,0)",e.fillRect(0,0,540,580),e.fillStyle="rgb(255,255,255)",e.font="bold 30px Courier New",e.fillText("START GAME",175,270),e.fillText("HIGH SCORES",175,320);var t=new Image;t.src="img/logo2.png",t.onload=function(){e.drawImage(t,44,20,450,200),e=null},$("#spaceinvaders").on("click.menu",function(e){var t=Math.floor(e.pageX-$(this).offset().left),n=Math.floor(e.pageY-$(this).offset().top);t>=176&&t<=361&&n>=251&&n<=273?($("#spaceinvaders").off("click.menu"),M=new ScoreManager,engine.tick()):t>=176&&t<=379&&n>=299&&n<=322&&($("#spaceinvaders").off("click.menu"),engine.highscore())})}var m,y,S,x,b=new Player,M=new ScoreManager,T=new WallManager,C=new InvaderManager,I=new ExplosionManager,k=1,R=1,A=[],D=!1,E=!1;return{input:function(){x=keyhandler.getMovement(),D=keyhandler.getAction()},logic:function(){(b.lives<1||C.getNumOfInvaders()<1)&&(E=!0),$.each(C.getInvaders(),function(e,t){for(var n=0;n<t.length;++n)if(t[n].getY()>460)return b.lives=0,void(E=!0)}),E||(n(),i(),o(),r(),a(),l())},render:function(){var t=$("#spaceinvaders")[0].getContext("2d");t.clearRect(0,0,540,580),t.fillStyle="rgb(0,0,0)",t.fillRect(0,0,540,580),p(t),g(t),T.draw(t),f(t),h(t),d(t),c(t),I.update(t),E&&(b.lives>0?s(t):e(t)),t=null},tick:v,menu:w,highscore:function(){var e=$("#spaceinvaders")[0].getContext("2d");e.fillStyle="rgb(0,0,0)",e.clearRect(0,250,540,580),e.fillRect(0,250,540,580),e.fillStyle="rgb(255,255,255)",M.showScores(e),$("#spaceinvaders").on("click.highscore",function(e){$("#spaceinvaders").off("click.highscore"),w()})}}}();$(document).ready(function(){configuration.init(),engine.menu()});