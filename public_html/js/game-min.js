function Drawable(a,b,c,d,e,f){this.x=a,this.y=b,this.width=c,this.height=d,this.column=e,this.row=f}function intersects(a,b,c,d,e,f,g,h){return g+=e,c+=a,!(e>c||a>g)&&(h+=f,d+=b,!(f>d||b>h))}function Movable(a,b,c,d,e,f){Drawable.call(this,a,b,c,d,e,f)}function Animation(a,b,c,d,e,f){this.image=a,this.frame_width=d,this.frame_height=e,this.current_x=b,this.current_y=c,this.change=!0,this.frameAddition=f}function InvaderManager(){function g(b,c){k(b,c),q()&&(f?h(-1-d,25):h(1+d,25),f=!f),spritemanager.changeSprite(a)&&(f?h(d,0):h(-d,0))}function h(b,c){$.each(a,function(a,d){for(var e=0;e<d.length;++e)d[e].move(b,c)})}function i(b){for(var c=0;c<a.length;++c)for(var d=0;d<a[c].length;++d)a[c][d].draw(b)}function j(b,c){for(var d=0;d<a.length;++d)for(var e=0;e<a[d].length;++e){var f=a[d][e];if(!f.hasCollided()&&f.doesCollide(b))return c.raiseScore(f.getRow()),f.explode(),l(d,e),!0}return!1}function k(b,c){for(var d=0;d<a.length;++d)for(var e=0;e<a[d].length;++e){var f=a[d][e];!f.hasCollided()&&b.doesCollide(f,c)&&(f.explode(),l(d,e))}}function l(a,c){setTimeout(function(){s(),r(a,c),--b},100)}function m(){for(var b=0;b<a.length;++b)invaderColumnShot[b]||n(a[b])&&(invaderColumnShot[b]=!0);return c}function n(a){return a.length>0&&Math.random()<e&&(c.push(a[a.length-1].shoot()),!0)}function o(){return b}function p(){return a}function q(){for(var b=0;b<a.length;++b)for(var c=0;c<a[b].length;++c)if(a[b][c].collidesWithEdge())return!0;return!1}function r(b,c){a[b].splice(c,1)}function s(){d+=.06,spritemanager.decreaseFrametime()}function t(a){d=a}function u(a){e=a}var a=[],b=55,c=[],d=3,e=.005,f=!0;return $.each(invaderData,function(b,c){var d=new Invader(c[0],c[1],c[2],c[3]),e=b%11;a[e]||(a[e]=[]);var f=spritemanager.getSprite(c[2]);d.createAnimation(f),a[e].push(d)}),{draw:i,doesCollide:j,getNumOfInvaders:o,shootLogic:m,update:g,getInvaders:p,setSpeed:t,setChance:u}}function Invader(a,b,c,d){Drawable.call(this,a,b,25,20,d,c),this.sprite=[],this.collision=!1,this.animation={}}function BonusInvader(){Drawable.call(this,10,80,30,20),this.img=new Image,this.img.src="img/bonus.png",this.directionRight=!0}function WallManager(){function d(b){for(var c=0;c<a.length;++c)a[c].draw(b)}function e(b,c){for(var d=0;d<a.length;++d)if(a[d].doesCollide(b,c))return!0;return!1}for(var a=[],b=0;b<4;++b){var c=new Wall(wallData[b],roundedTilesData[b]);a.push(c)}return{draw:d,doesCollide:e}}function Wall(a,b){function f(a){for(var b=0;b<e.length;++b)e[b].draw(a)}function g(a,b){for(var c=0;c<e.length;++c)if(e[c].doesCollide(a))return b.newExplosion(e[c].getX(),e[c].getY()),h(c),!0;return!1}function h(a){e.splice(a,1)}var c=new Array,d=new Array,e=new Array;return $.each(b,function(a,b){var c=new RoundedTile(b[0],b[1],b[2]);d.push(c),e.push(c)}),$.each(a,function(a,b){var d=new Tile(b[0],b[1]);c.push(d),e.push(d)}),{draw:f,doesCollide:g}}function Tile(a,b){Drawable.call(this,a,b,14,20)}function RoundedTile(a,b,c){this.clockwise=c,Drawable.call(this,a,b,14,20)}function Player(){Movable.call(this,260,500,25,25),this.lives=3,this.img=new Image,this.img.src="img/ships2.png"}function Missile(a,b,c){Drawable.call(this,a,b,3,5,c)}function ScoreManager(){function e(c){a+=c<1?30:c<3?20:5==c?100:10,a>b&&(b=a)}function f(){return b}function g(){return a}function h(){c.save({userID:$.cookie("userId"),score:a})}function i(a){d.equalTo("userID",$.cookie("userId")),d.exists("score"),d.descending("score"),d.limit(5),d.find({success:function(b){if(a.font="20px Courier New",b.length<1)return void a.fillText("No scores yet! Go and play!",115,305);for(var c=305,d=0;d<b.length;++d)a.fillText(d+1+": "+b[d].attributes.score,230,c),c+=30}})}Parse.initialize("xR4SolA0VPCzrf7Pp9zuBDVOM6EB6KodPAnWbgso","JoAmAsdAt3lHQCkqAIVPVDDyYMVCRIo9PZrrQfMM");var a=0,b=0,c=new GameScore,d=new Parse.Query(GameScore);return d.equalTo("userID",$.cookie("userId")),d.descending("score"),d.limit(1),d.find({success:function(a){b=0==a.length?0:a[0].attributes.score}}),{raiseScore:e,getScore:g,getHighScore:f,showScores:i,postScore:h}}function ExplosionManager(){function b(b,c){a.push(new Explosion(b,c)),soundManager.explosionSound()}function c(b){for(var c=0;c<a.length;++c){var e=a[c];e.empty()&&(a.splice(c,1),--c)}a.length>0&&d(b)}function d(b){for(var c=0;c<a.length;++c)a[c].draw(b)}var a=[];return{update:c,newExplosion:b}}function Explosion(a,b){this.particles=[];for(var c=0;c<30;++c)this.particles.push(new Particle(a,b))}function Particle(a,b){this.x=a,this.y=b,this.radius=3+4*Math.random(),this.r=255*Math.round(Math.random()),this.g=255*Math.round(Math.random()),this.b=255*Math.round(Math.random()),this.vx=-10+20*Math.random(),this.vy=-10+20*Math.random()}var spritemanager={};spritemanager=function(){function c(c){var d=(new Date).getTime()/1e3;if(d-b>a){for(var e=0;e<c.length;++e)for(var f=0;f<c[e].length;++f)c[e][f].animate(),b=d;return!0}return!1}function d(a){return 0==a?sprite=[0,4,30,25]:1==a||2==a?sprite=[69,4,30,25]:sprite=[143,4,30,25]}function e(){a-=.009}function f(){a=.5}var a=.5,b=0;return{changeSprite:c,getSprite:d,decreaseFrametime:e,resetFrametime:f}}();var configuration=function(){function a(){1==jQuery.browser.mobile?(b(),c(),f()):d(),e(),g()}function b(){soundManager.disableSounds()}function c(){$("<div/>").attr("id","left").text("Left").appendTo(".buttons"),$("<div/>").attr("id","shoot").text("Shoot").appendTo(".buttons"),$("<div/>").attr("id","right").text("Right").appendTo(".buttons")}function d(){$("#spaceinvaders").click(function(a){var b=Math.floor(a.pageX-$(this).offset().left),c=Math.floor(a.pageY-$(this).offset().top);b>=502&&b<=535&&c>=545&&c<=580&&(soundManager.areSoundsOn()?soundManager.disableSounds():soundManager.enableSounds())})}function e(){$(document).keydown(function(a){keyhandler.keydown(a.which),keyhandler.isValidKey(a.which)&&a.preventDefault()}),$(document).keyup(function(a){keyhandler.keyup(a.which),keyhandler.isValidKey(a.which)&&a.preventDefault()})}function f(){$("#right").swipe({swipeStatus:function(a,b,c,d,e,f){"start"!=b&&"move"!=b||keyhandler.pressRight(),"end"!=b&&"cancel"!=b||keyhandler.clear()}}),$("#left").swipe({swipeStatus:function(a,b,c,d,e,f){"start"!=b&&"move"!=b||keyhandler.pressLeft(),"end"!=b&&"cancel"!=b||keyhandler.clear()}}),$("#shoot").swipe({swipeStatus:function(a,b,c,d,e,f){"start"!=b&&"move"!=b||keyhandler.pressUp(),"end"!=b&&"cancel"!=b||keyhandler.clear()}})}function g(){h()}function h(){var a=localStorage.getItem("userId");if(null!=a&&$.cookie("userId",a),null==$.cookie("userId")){var b=i();localStorage.setItem("userId",b),$.cookie("userId",b,{expires:30})}}function i(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;c<5;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}return{init:a}}(),soundManager=function(){function f(){a=!0}function g(){a=!1}function h(){if(a){var b=c;b.volume=.6,b.load(),b.play()}}function i(){if(a){var c=b;c.volume=.4,c.load(),c.play()}}function j(){if(a){var b=d;b.volume=.3,b.load(),b.play()}}function k(){if(a){var b=e;b.volume=.1,b.play()}}function l(){return a}var a=!0,b=$("#8bit-explosion")[0],c=$("#explosion")[0],d=$("#missile")[0],e=$("#flight")[0];return{areSoundsOn:l,enableSounds:f,disableSounds:g,explosionSound:h,eightBitExplosionSound:i,missileSound:j,flightSound:k}}();Drawable.prototype.move=function(a,b){this.x+=a,this.y+=b},Drawable.prototype.getX=function(){return this.x},Drawable.prototype.getY=function(){return this.y},Drawable.prototype.getWidth=function(){return this.width},Drawable.prototype.getHeight=function(){return this.height},Drawable.prototype.getColumn=function(){return this.column},Drawable.prototype.getRow=function(){return this.row},Drawable.prototype.doesCollide=function(a){return!!intersects(this.x,this.y,this.width,this.height,a.getX(),a.getY(),a.getWidth(),a.getHeight())},Movable.prototype=new Drawable,Movable.prototype.constructor=Movable,Movable.prototype.shoot=function(){return soundManager.missileSound(),null!=this.column?new Missile(this.x+10,this.y+15,this.column):new Missile(this.x+10,this.y+5,this.column)},Movable.prototype.collidesWithEdge=function(){return this.x>514||this.x<0},Animation.prototype.next=function(){this.change?this.current_x+=this.frameAddition:this.current_x-=this.frameAddition,this.change=!this.change},Animation.prototype.draw=function(a,b,c,d,e){a.drawImage(this.image,this.current_x,this.current_y,this.frame_width,this.frame_height,b,c,d,e)};var invaderData=[[60,135,0,0],[100,135,0,1],[140,135,0,2],[180,135,0,3],[220,135,0,4],[260,135,0,5],[300,135,0,6],[340,135,0,7],[380,135,0,8],[420,135,0,9],[460,135,0,10],[60,160,1,0],[100,160,1,1],[140,160,1,2],[180,160,1,3],[220,160,1,4],[260,160,1,5],[300,160,1,6],[340,160,1,7],[380,160,1,8],[420,160,1,9],[460,160,1,10],[60,185,2,0],[100,185,2,1],[140,185,2,2],[180,185,2,3],[220,185,2,4],[260,185,2,5],[300,185,2,6],[340,185,2,7],[380,185,2,8],[420,185,2,9],[460,185,2,10],[60,210,3,0],[100,210,3,1],[140,210,3,2],[180,210,3,3],[220,210,3,4],[260,210,3,5],[300,210,3,6],[340,210,3,7],[380,210,3,8],[420,210,3,9],[460,210,3,10],[60,235,4,0],[100,235,4,1],[140,235,4,2],[180,235,4,3],[220,235,4,4],[260,235,4,5],[300,235,4,6],[340,235,4,7],[380,235,4,8],[420,235,4,9],[460,235,4,10]],invaderColumnShot=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];Invader.prototype=new Movable,Invader.prototype.constructor=Invader,Invader.prototype.draw=function(a){this.animation.draw(a,this.x,this.y,this.width,this.height)},Invader.prototype.createAnimation=function(a){this.sprite=a,this.animation=new Animation($("#invaders")[0],this.sprite[0],this.sprite[1],this.sprite[2],this.sprite[3],32)},Invader.prototype.animate=function(){this.animation.next()},Invader.prototype.hasCollided=function(){return this.collision},Invader.prototype.explode=function(){soundManager.eightBitExplosionSound(),this.animation=new Animation($("#kaboom")[0],0,0,34,23,0),this.collision=!0},BonusInvader.prototype=new Movable,BonusInvader.prototype.constructor=BonusInvader,BonusInvader.prototype.draw=function(a){soundManager.flightSound(),a.drawImage(this.img,0,0,52,27,this.x,this.y,this.width,this.height)};var keyhandler=function(){function c(){return a[38]||a[175]||a[87]}function e(){return a[37]||a[178]||a[65]}function f(){return a[39]||a[177]||a[68]}function g(b){a[b]=!0}function h(b){a[b]=!1}function i(){a[38]=!0,a[175]=!0,a[87]=!0,a[32]=!0}function j(){a[37]=!0,a[178]=!0,a[65]=!0}function k(){a[39]=!0,a[177]=!0,a[68]=!0}function l(){return!(!c()&&!a[32])}function m(){var a=0;return e()&&(a=-2),f()&&(a=2),a}function n(a){return 38==a||175==a||87==a||32==a||37==a||178==a||65==a||39==a||177==a||68==a||40==a}function o(){for(var b=0;b<256;)a[b]=!1,b+=1}for(var a=new Array,b=0;b<256;)a[b]=!1,b+=1;return{isValidKey:n,keydown:g,keyup:h,getMovement:m,getAction:l,clear:o,pressLeft:j,pressRight:k,pressUp:i}}(),wallData=[[[77,455],[119,455],[91,435],[105,435]],[[187,455],[229,455],[201,435],[215,435]],[[297,455],[339,455],[311,435],[325,435]],[[407,455],[449,455],[421,435],[435,435]]],roundedTilesData=[[[77,435,!1],[119,435,!0]],[[187,435,!1],[229,435,!0]],[[297,435,!1],[339,435,!0]],[[407,435,!1],[449,435,!0]]];Tile.prototype=new Drawable,Tile.prototype.constructor=Tile,Tile.prototype.draw=function(a){a.fillStyle="rgb(0,255,0)",a.fillRect(this.x,this.y,this.width,this.height)},RoundedTile.prototype=new Drawable,RoundedTile.prototype.constructor=RoundedTile,RoundedTile.prototype.draw=function(a){a.fillStyle="rgb(0,255,0)",a.strokeStyle="rgb(0,255,0)",a.lineWidth=1,a.beginPath(),this.clockwise?this.drawClockWise(a):this.drawCounterClockWise(a),a.stroke(),a.fill()},RoundedTile.prototype.drawClockWise=function(a){a.moveTo(this.x+.5,this.y),a.lineTo(this.x+.5,this.y+this.height-.5),a.lineTo(this.x+this.width-.5,this.y+this.height-.5),a.quadraticCurveTo(this.x+this.width,this.y+.5,this.x,this.y+.5)},RoundedTile.prototype.drawCounterClockWise=function(a){var b=this.x+this.width;a.moveTo(b-.5,this.y),a.lineTo(b-.5,this.y+this.height-.5),a.lineTo(b-this.width+.5,this.y+this.height-.5),a.quadraticCurveTo(b-this.width,this.y+.5,b,this.y+.5)},Player.prototype=new Movable,Player.prototype.constructor=Player,Player.prototype.draw=function(a,b){a.drawImage(this.img,b,12,80,72,this.x,this.y,this.width,this.height)},Missile.prototype=new Drawable,Missile.prototype.constructor=Missile,Missile.prototype.draw=function(a){a.fillStyle="rgb(255,255,255)",a.fillRect(this.x,this.y,this.width,this.height)};var GameScore=Parse.Object.extend("GameScore");Explosion.prototype.empty=function(){for(var a=0;a<this.particles.length;++a)this.particles[a].radius<=0&&(this.particles.splice(a,1),--a);return 0==this.particles.length},Explosion.prototype.draw=function(a){for(var b=0;b<this.particles.length;b++){var c=this.particles[b];a.beginPath(),a.globalCompositeOperation="lighter",a.arc(c.x,c.y,c.radius,0,2*Math.PI,!1),a.fillStyle="rgba("+c.r+", "+c.g+", "+c.b+", 0.5)",a.fill(),c.x+=c.vx,c.y+=c.vy,c.radius-=.2}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var engine=function(){function o(){l=keyhandler.getMovement(),m=keyhandler.getAction()}function p(){(a.lives<1||d.getNumOfInvaders()<1)&&(n=!0),$.each(d.getInvaders(),function(b,c){for(var d=0;d<c.length;++d)if(c[d].getY()>460)return a.lives=0,void(n=!0)}),n||(s(),t(),u(),v(),w(),x())}function q(a){a.fillStyle="rgb(0,0,0)",a.fillRect(180,265,180,33),a.font="bold 30px Courier New",a.fillStyle="rgb(255,255,255)",a.fillText("GAME OVER",190,280),r(a),$("#spaceinvaders").on("click.endGame",function(a){$("#spaceinvaders").off("click.endGame"),A(),I()})}function r(a){n&&b.postScore(),b.showScores(a)}function s(){a.collidesWithEdge()?a.getX()>514&&l<0?a.move(l,0):a.getX()<0&&l>0&&a.move(l,0):a.collidesWithEdge()||a.move(l,0)}function t(){m&&null==i&&(i=a.shoot()),null!=i&&(c.doesCollide(i,e)||d.doesCollide(i,b)?i=null:null!=f&&f.doesCollide(i)?(i=null,e.newExplosion(f.getX(),f.getY()),f=null,b.raiseScore(5)):i.getY()<70?i=null:i.move(0,-10))}function u(){null==f&&h>0&&d.getNumOfInvaders()<35&&Math.floor(1e3*Math.random()+1)<3&&(f=new BonusInvader,h=0),null!=f&&(f.collidesWithEdge()&&(f.directionRight=!f.directionRight),f.directionRight?f.move(3,0):f.move(-3,0),null==j&&Math.random()<.015&&(j=f.shoot()))}function v(){null!=j&&(a.doesCollide(j)?(a.lives-=1,e.newExplosion(a.getX(),a.getY()),j=null):c.doesCollide(j,e)||j.getY()>533?j=null:j.move(0,3))}function w(){d.update(c,e)}function x(){if(k=d.shootLogic(),k.length>0)for(var b=0;b<k.length;++b){var f=k[b];a.doesCollide(f)?(a.lives-=1,e.newExplosion(a.getX(),a.getY()),invaderColumnShot[f.getColumn()]=!1,k.splice(b,1),--b):c.doesCollide(f,e)||f.getY()>533?(invaderColumnShot[f.getColumn()]=!1,k.splice(b,1),--b):f.move(0,1)}}function y(){var b=$("#spaceinvaders")[0].getContext("2d");b.clearRect(0,0,540,580),b.fillStyle="rgb(0,0,0)",b.fillRect(0,0,540,580),G(b),F(b),c.draw(b),E(b),B(b),D(b),C(b),e.update(b),n&&(a.lives>0?z(b):q(b)),b=null}function z(a){a.fillStyle="rgb(0,0,0)",a.fillRect(180,265,180,33),a.font="20px Courier New",a.fillStyle="rgb(255,255,255)",a.fillText("CONGRATULATIONS!",178,250),a.fillText("Next level is about to start...",85,280),setTimeout(function(){A(),++g,d.setSpeed(3+g/10),d.setChance(.005+g/250),H()},3e3)}function A(){a.lives<1&&(a=new Player),d=new InvaderManager,c=new WallManager,e=new ExplosionManager,i=null,j=null,f=null,h=1,k=null,spritemanager.resetFrametime(),m=!1,n=!1;for(var b=0;b<invaderColumnShot.length;++b)invaderColumnShot[b]=!1}function B(b){b.lineWidth=2,b.strokeStyle="rgb(0,255,0)",b.beginPath(),b.moveTo(0,540),b.lineTo(540,540),b.stroke();for(var c=a.img,d=50,e=0;e<a.lives;++e)b.drawImage(c,0,12,80,72,d,550,25,25),d+=30;b.font="20px Courier New",b.fillStyle="rgb(255, 255, 255)",b.fillText(a.lives+"x",20,570),b.fillText("LEVEL",340,30),b.fillText(g,340,50)}function C(a){var b=$("#sound-icon")[0];a.drawImage(b,500,543,35,35),soundManager.areSoundsOn()||(a.strokeStyle="rgb(255,255,255)",a.lineWidth=2,a.beginPath(),a.moveTo(507,571),a.lineTo(529,550),a.stroke())}function D(a){a.fillText("SCORE",20,30),a.fillText(b.getScore(),20,50),a.fillText("HIGH SCORE",140,30),a.fillText(b.getHighScore(),140,50)}function E(a){null!=f&&f.draw(a),d.draw(a)}function F(b){var c;c=l==-2?147:2==l?78:0,a.draw(b,c)}function G(a){null!=i&&i.draw(a),null!=j&&j.draw(a),k.length>0&&$.each(k,function(b,c){c.draw(a)})}function H(){engine.input(),engine.logic(),engine.render(),n||requestAnimFrame(engine.tick)}function I(){var a=$("#spaceinvaders")[0].getContext("2d");a.clearRect(0,0,540,580),a.fillStyle="rgb(0,0,0)",a.fillRect(0,0,540,580),a.fillStyle="rgb(255,255,255)",a.font="bold 30px Courier New",a.fillText("START GAME",175,270),a.fillText("HIGH SCORES",175,320);var c=new Image;c.src="img/logo2.png",c.onload=function(){a.drawImage(c,44,20,450,200),a=null},$("#spaceinvaders").on("click.menu",function(a){var c=Math.floor(a.pageX-$(this).offset().left),d=Math.floor(a.pageY-$(this).offset().top);c>=176&&c<=361&&d>=251&&d<=273?($("#spaceinvaders").off("click.menu"),b=new ScoreManager,engine.tick()):c>=176&&c<=379&&d>=299&&d<=322&&($("#spaceinvaders").off("click.menu"),engine.highscore())})}function J(){var a=$("#spaceinvaders")[0].getContext("2d");a.fillStyle="rgb(0,0,0)",a.clearRect(0,250,540,580),a.fillRect(0,250,540,580),a.fillStyle="rgb(255,255,255)",b.showScores(a),$("#spaceinvaders").on("click.highscore",function(a){$("#spaceinvaders").off("click.highscore"),I()})}var f,i,j,l,a=new Player,b=new ScoreManager,c=new WallManager,d=new InvaderManager,e=new ExplosionManager,g=1,h=1,k=[],m=!1,n=!1;return{input:o,logic:p,render:y,tick:H,menu:I,highscore:J}}();$(document).ready(function(){configuration.init(),engine.menu()});
